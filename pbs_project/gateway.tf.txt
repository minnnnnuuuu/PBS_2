# 1. Gateway API 사전(CRD) 자동 설치 (null_resource 사용)
resource "null_resource" "install_gateway_crds" {
  # 클러스터 정보가 바뀌거나 필요할 때 실행되도록 설정
  triggers = {
    cluster_endpoint = module.eks.cluster_endpoint
    #cluster_endpoint = aws_eks_cluster.this.endpoint
    #cluster_endpoint = data.aws_eks_cluster.cluster.endpoint
  }

  # 테라폼이 직접 kubectl 명령어를 날려 사전을 설치합니다. (100% 자동화)
  provisioner "local-exec" {
    command = "aws eks update-kubeconfig --region ap-northeast-2 --name ${module.eks.cluster_name} && kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.1.0/standard-install.yaml"
    #command = "kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.1.0/standard-install.yaml"
  }
}

# 2. Gateway 리소스 생성
resource "kubernetes_manifest" "pbs_gateway" {
  manifest = {
    apiVersion = "gateway.networking.k8s.io/v1beta1"
    kind       = "Gateway"
    metadata = {
      name      = "pbs-gateway"
      namespace = "kube-system"
      annotations = {
        "alb.networking.k8s.io/scheme" = "internet-facing"
        
        "alb.networking.k8s.io/wafv2-acl-arn" = module.waf.web_acl_arn
        #"alb.networking.k8s.io/wafv2-acl-arn" = "arn:aws:wafv2:ap-northeast-2:198011705652:regional/webacl/pbs-project-web-acl/51b25950-c51a-4974-8100-e993b35b62d2"
      }
    }
    spec = {
      gatewayClassName = "amazon-lbc"
      listeners = [{
        name     = "http"
        port     = 80
        protocol = "HTTP"
        allowedRoutes = { namespaces = { from = "All" } }
      }]
    }
  }

  # ★ 핵심: null_resource(사전 설치)가 끝난 뒤에 대문을 만듭니다.
  depends_on = [null_resource.install_gateway_crds,module.waf]
}