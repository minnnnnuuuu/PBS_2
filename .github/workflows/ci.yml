name: PBS_2 CI Pipeline (Build Only Mode)

on:
  push:
    branches: [ "main" ] # ë©”ì¸ ë¸Œëœì¹˜ì— ì½”ë“œê°€ ì˜¬ë¼ì˜¤ë©´ ìš”ì •ì´ ì›€ì§ì…ë‹ˆë‹¤.

jobs:
  build-test:
    runs-on: ubuntu-latest # ê¹ƒí—ˆë¸Œê°€ ë¬´ë£Œë¡œ ë¹Œë ¤ì£¼ëŠ” ì»´í“¨í„°ì…ë‹ˆë‹¤.
    
    steps:
    - name: 1. ì„¤ê³„ë„(ì½”ë“œ) ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4

    - name: 2. AWS ì‹ ë¶„ì¦ í™•ì¸
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2 

    - name: 3. AWS ECR ì°½ê³  ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë„ì‹œë½ ì‹¸ê¸°)
      run: |
        REGISTRY=${{ steps.login-ecr.outputs.registry }}
        REPOSITORY=${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG=${{ github.sha }}
        
        # ì‹¤ì œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì§€ë§Œ, ì—…ë¡œë“œëŠ” í•˜ì§€ ì•Šì•„ ë¹„ìš©ì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
        echo "âœ… ë¹Œë“œ ì„±ê³µ! ì„¤ê³„ë„ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."

    # ---------------------------------------------------------
    # âš ï¸ ë¹„ìš© ë°©ì§€ë¥¼ ìœ„í•´ Push ëª…ë ¹ì€ ì£¼ì„ ì²˜ë¦¬(##) ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    # ë‚˜ì¤‘ì— ì œì¶œ ì§ì „ì— ##ë§Œ ì§€ìš°ë©´ ì‹¤ì œë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
    # ---------------------------------------------------------
    - name: 5. ì´ë¯¸ì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸ (Skip)
      run: |
        echo "ğŸ“¢ í˜„ì¬ëŠ” ë¹„ìš© ì ˆê° ëª¨ë“œì…ë‹ˆë‹¤. Pushë¥¼ ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        ## REGISTRY=${{ steps.login-ecr.outputs.registry }}
        ## REPOSITORY=${{ secrets.ECR_REPOSITORY }}
        ## IMAGE_TAG=${{ github.sha }}
        ## docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
